<p align="center">
  <img src="public/icons/icon-192x192.png" alt="MoeMail Logo" width="100" height="100">
  <h1 align="center">MoeMail</h1>
</p>

<p align="center">
  ä¸€ä¸ªåŸºäº NextJS + Cloudflare æŠ€æœ¯æ ˆæ„å»ºçš„å¯çˆ±ä¸´æ—¶é‚®ç®±æœåŠ¡ğŸ‰
</p>

<p align="center">
  <a href="#åœ¨çº¿æ¼”ç¤º">åœ¨çº¿æ¼”ç¤º</a> â€¢
  <a href="#ç‰¹æ€§">ç‰¹æ€§</a> â€¢
  <a href="#æŠ€æœ¯æ ˆ">æŠ€æœ¯æ ˆ</a> â€¢
  <a href="#æœ¬åœ°è¿è¡Œ">æœ¬åœ°è¿è¡Œ</a> â€¢
  <a href="#éƒ¨ç½²">éƒ¨ç½²</a> â€¢
  <a href="#Webhook é›†æˆ">Webhook é›†æˆ</a> â€¢
  <a href="#ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</a> â€¢
  <a href="#Github OAuth App é…ç½®">Github OAuth App é…ç½®</a> â€¢
  <a href="#è´¡çŒ®">è´¡çŒ®</a> â€¢
  <a href="#è®¸å¯è¯">è®¸å¯è¯</a> â€¢
  <a href="#äº¤æµç¾¤">äº¤æµç¾¤</a> â€¢
  <a href="#æ”¯æŒ">æ”¯æŒ</a>
</p>

# ä¸€ã€åœ¨çº¿æ¼”ç¤º
[https://moemail.app](https://moemail.app)

![é¦–é¡µ](https://pic.otaku.ren/20241209/AQADwsUxG9k1uVZ-.jpg "é¦–é¡µ")


![é‚®ç®±](https://pic.otaku.ren/20241209/AQADw8UxG9k1uVZ-.jpg "é‚®ç®±")

![ä¸ªäººä¸­å¿ƒ](https://pic.otaku.ren/20241217/AQAD9sQxG0g1EVd-.jpg "ä¸ªäººä¸­å¿ƒ")

## ç‰¹æ€§

- ğŸ”’ **éšç§ä¿æŠ¤**ï¼šä¿æŠ¤æ‚¨çš„çœŸå®é‚®ç®±åœ°å€ï¼Œè¿œç¦»åƒåœ¾é‚®ä»¶å’Œä¸å¿…è¦çš„è®¢é˜…
- âš¡ **å®æ—¶æ”¶ä»¶**ï¼šè‡ªåŠ¨è½®è¯¢ï¼Œå³æ—¶æ¥æ”¶é‚®ä»¶é€šçŸ¥
- â±ï¸ **çµæ´»æœ‰æ•ˆæœŸ**ï¼šæ”¯æŒ 1 å°æ—¶ã€24 å°æ—¶ã€3 å¤©æˆ–æ°¸ä¹…æœ‰æ•ˆ
- ğŸ¨ **ä¸»é¢˜åˆ‡æ¢**ï¼šæ”¯æŒäº®è‰²å’Œæš—è‰²æ¨¡å¼
- ğŸ“± **å“åº”å¼è®¾è®¡**ï¼šå®Œç¾é€‚é…æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
- ğŸ”„ **è‡ªåŠ¨æ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„é‚®ç®±å’Œé‚®ä»¶
- ğŸ“± **PWA æ”¯æŒ**ï¼šæ”¯æŒ PWA å®‰è£…
- ğŸ’¸ **å…è´¹è‡ªéƒ¨ç½²**ï¼šåŸºäº Cloudflare æ„å»º, å¯å®ç°å…è´¹è‡ªéƒ¨ç½²ï¼Œæ— éœ€ä»»ä½•è´¹ç”¨
- ğŸ‰ **å¯çˆ±çš„ UI**ï¼šç®€æ´å¯çˆ±èŒèŒå“’ UI ç•Œé¢
- ğŸ”” **Webhook é€šçŸ¥**ï¼šæ”¯æŒé€šè¿‡ webhook æ¥æ”¶æ–°é‚®ä»¶é€šçŸ¥

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: [Next.js](https://nextjs.org/) (App Router)
- **å¹³å°**: [Cloudflare Pages](https://pages.cloudflare.com/)
- **æ•°æ®åº“**: [Cloudflare D1](https://developers.cloudflare.com/d1/) (SQLite)
- **è®¤è¯**: [NextAuth](https://authjs.dev/getting-started/installation?framework=Next.js) é…åˆ GitHub ç™»å½•
- **æ ·å¼**: [Tailwind CSS](https://tailwindcss.com/)
- **UI ç»„ä»¶**: åŸºäº [Radix UI](https://www.radix-ui.com/) çš„è‡ªå®šä¹‰ç»„ä»¶
- **é‚®ä»¶å¤„ç†**: [Cloudflare Email Workers](https://developers.cloudflare.com/email-routing/)
- **ç±»å‹å®‰å…¨**: [TypeScript](https://www.typescriptlang.org/)
- **ORM**: [Drizzle ORM](https://orm.drizzle.team/)
# äºŒã€å˜é‡é¢„è§ˆ
### Github Actions Secrets é…ç½®
|å˜é‡å|è·å–|ç¤ºä¾‹|ä½œç”¨|
|--|--|--|--|
|`CLOUDFLARE_ACCOUNT_ID`|[Workers Dashboard](https://dash.cloudflare.com/?to=/:account/workers)|`5eb191067edd4db3********`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`CLOUDFLARE_API_TOKEN`|[API](https://dash.cloudflare.com/profile/api-tokens)|`udfsifds***`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`DATABASE_NAME`|[D1 NAME](https://dash.cloudflare.com/?to=/:account/workers/d1)|`moemail`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`DATABASE_ID`|[D1 ID](https://dash.cloudflare.com/?to=/:account/workers/d1/databases)|`8c0a179b-60b5-418a-a77*-**`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`NEXT_PUBLIC_EMAIL_DOMAIN`|è‡ªè¡Œè¾“å…¥|`moemail.app`|ä½œä¸ºé‚®ç®±åç¼€|
---  
### Cloudflare ç¯å¢ƒå˜é‡é…ç½®
|å˜é‡å|è·å–|ç¤ºä¾‹|ä½œç”¨
|--|--|--|--|
|`AUTH_GITHUB_ID`| [GitHub Developers](https://github.com/settings/developers)|sdfds***|å¿…è¦è®¾ç½®|
|`AUTH_GITHUB_SECRET`|[GitHub Developers](https://github.com/settings/developers)|sadadf***|ç®¡ç†å‘˜å¿…è¦è®¾ç½®|
|`AUTH_SECRET`|éšæ„|123456|ç”¨äºéªŒè¯|
---
# ä¸‰ã€éƒ¨ç½²
## 1. Github Actions éƒ¨ç½²

### éƒ¨ç½²æ­¥éª¤
#### Githubé…ç½®
1. ç‚¹èµå¹¶forkè¯¥ä»“åº“
2. è¿›å…¥forkçš„ä»“åº“ä¸­ï¼Œç‚¹å‡»`settings`-->`secrets and variables`-->`Actions`-->`New respository secret`æ·»åŠ å¦‚ä¸‹å˜é‡
    - **æ³¨æ„**ï¼š`CLOUDFLARE_API_TOKEN`è®¾ç½®ï¼š`åˆ›å»ºä»¤ç‰Œ`-->`ç¼–è¾‘ Cloudflare Workers`-->`æ·»åŠ æ›´å¤š`-->æ‰¾åˆ°`D1`-->å¯¹åº”æƒé™`ç¼–è¾‘`

|å˜é‡å|è·å–|ç¤ºä¾‹|ä½œç”¨|
|--|--|--|--|
|`CLOUDFLARE_ACCOUNT_ID`|[Workers Dashboard](https://dash.cloudflare.com/?to=/:account/workers)|`5eb191067edd4db3********`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`CLOUDFLARE_API_TOKEN`|[API](https://dash.cloudflare.com/profile/api-tokens)|`udfsifds***`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`DATABASE_NAME`|[D1 NAME](https://dash.cloudflare.com/?to=/:account/workers/d1)|`moemail`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`DATABASE_ID`|[D1 ID](https://dash.cloudflare.com/?to=/:account/workers/d1/databases)|`8c0a179b-60b5-418a-a77*-**`|ä¾›Actionséƒ¨ç½²ä½¿ç”¨|
|`NEXT_PUBLIC_EMAIL_DOMAIN`|è‡ªè¡Œè¾“å…¥|`moemail.app`,`b.com`|ä½œä¸ºé‚®ç®±åç¼€(å¤šä¸ªæ·»åŠ ï¼Œä»¥é€—å·éš”å¼€)|


3. è®¾ç½®å¥½åï¼Œè¿›å…¥ä»“åº“çš„ Actions é¡µé¢
    - é€‰æ‹© "Deploy" workflow
    - ç‚¹å‡» "Run workflow"
    - é€‰æ‹©éœ€è¦æ‰§è¡Œçš„éƒ¨ç½²é€‰é¡¹
    - ç‚¹å‡» "Run workflow" å¼€å§‹éƒ¨ç½²  
4. ç­‰å¾…éƒ¨ç½²å®Œæˆå³å¯ï¼ˆéƒ¨ç½²è¿›åº¦å¯ä»¥åœ¨ä»“åº“çš„ Actions æ ‡ç­¾é¡µæŸ¥çœ‹ï¼‰  
#### Cloudflareå˜é‡é…ç½®                    
5. éƒ¨ç½²å®Œæˆåï¼Œè¿›å…¥[cloudflare Workers and pages](https://dash.cloudflare.com/) 
6. åœ¨ Overview ä¸­é€‰æ‹©åˆšåˆšéƒ¨ç½²çš„ Cloudflare Pagesï¼ˆåº”è¯¥æ˜¯`moemail`ï¼‰
7. åœ¨ Settings ä¸­é€‰æ‹©å˜é‡å’Œæœºå¯†ï¼Œæ·»åŠ å¦‚ä¸‹å˜é‡

     **å˜é‡è·å–æ­¥éª¤ï¼š**   

      - ç™»å½• [Github Developer](https://github.com/settings/developers) åˆ›å»ºä¸€ä¸ªæ–°çš„ OAuth App
      - ç”Ÿæˆä¸€ä¸ªæ–°çš„ `Client ID` å’Œ `Client Secret`
      - è®¾ç½® `Application name` ä¸º `<your-app-name>`
      - è®¾ç½® `Homepage URL` ä¸º `https://<your-domain>`ï¼ˆè¯¥åŸŸåç”¨äºè®¿é—®ï¼‰
      - è®¾ç½® `Authorization callback URL` ä¸º `https://<your-domain>/api/auth/callback/github`
---
|å˜é‡å|è·å–|ç¤ºä¾‹|ä½œç”¨
|--|--|--|--|
|`AUTH_GITHUB_ID`| [GitHub Developers](https://github.com/settings/developers)|sdfds***|ç®¡ç†å‘˜å¿…è¦è®¾ç½®|
|`AUTH_GITHUB_SECRET`|[GitHub Developers](https://github.com/settings/developers)|sadadf***|ç®¡ç†å‘˜å¿…è¦è®¾ç½®|
|`AUTH_SECRET`|éšæ„|123456|ç”¨äºé¡µé¢éªŒè¯|

#### Cloudflareé‚®ä»¶è·¯ç”±é…ç½®
8. éœ€è¦åœ¨ Cloudflare æ§åˆ¶å°é…ç½®é‚®ä»¶è·¯ç”±ï¼Œå°†æ”¶åˆ°çš„é‚®ä»¶è½¬å‘ç»™ Email Worker å¤„ç†ã€‚

    - é€‰æ‹©æ‚¨çš„åŸŸå
    - ç‚¹å‡»å·¦ä¾§èœå•çš„ "**ç”µå­é‚®ä»¶**" -> "**ç”µå­é‚®ä»¶è·¯ç”±**"
    - å¦‚æœæ˜¾ç¤º â€œç”µå­é‚®ä»¶è·¯ç”±å½“å‰è¢«ç¦ç”¨ï¼Œæ²¡æœ‰åœ¨è·¯ç”±ç”µå­é‚®ä»¶â€ï¼Œè¯·ç‚¹å‡» "å¯ç”¨ç”µå­é‚®ä»¶è·¯ç”±"
    ![å¯ç”¨ç”µå­é‚®ä»¶è·¯ç”±](https://pic.otaku.ren/20241223/AQADNcQxG_K0SVd-.jpg "å¯ç”¨ç”µå­é‚®ä»¶è·¯ç”±")
    - ç‚¹å‡»åï¼Œä¼šæç¤ºä½ æ·»åŠ ç”µå­é‚®ä»¶è·¯ç”± DNS è®°å½•ï¼Œç‚¹å‡» â€œ**æ·»åŠ è®°å½•å¹¶å¯ç”¨**â€ å³å¯
    ![æ·»åŠ ç”µå­é‚®ä»¶è·¯ç”± DNS è®°å½•](https://pic.otaku.ren/20241223/AQADN8QxG_K0SVd-.jpg "æ·»åŠ ç”µå­é‚®ä»¶è·¯ç”± DNS è®°å½•")
    - é…ç½®è·¯ç”±è§„åˆ™ï¼š
      - Catch-all åœ°å€: å¯ç”¨ "**Catch-all**"
      - ç¼–è¾‘ Catch-all åœ°å€
        - æ“ä½œ: é€‰æ‹© "**å‘é€åˆ° Worker**"
        - ç›®æ ‡ä½ç½®: é€‰æ‹©åˆšåˆšéƒ¨ç½²çš„ "**email-receiver-worker**"
        - ä¿å­˜
      ![é…ç½®è·¯ç”±è§„åˆ™](https://pic.otaku.ren/20241223/AQADNsQxG_K0SVd-.jpg "é…ç½®è·¯ç”±è§„åˆ™")
9. **æ³¨æ„äº‹é¡¹**
    - ç¡®ä¿åŸŸåçš„ DNS æ‰˜ç®¡åœ¨ Cloudflare
    - Email Worker å¿…é¡»å·²ç»éƒ¨ç½²æˆåŠŸ
10.  ç„¶åå›åˆ°GitHubé‡è¯•éƒ¨ç½²ï¼Œè®©æ‰€æœ‰å˜é‡ç”Ÿæ•ˆ
## 2. æœ¬åœ°è¿è¡Œä¸Wrangleréƒ¨ç½²

### å‰ç½®è¦æ±‚

- Node.js 18+
- pnpm
- Wrangler CLI
- Cloudflare è´¦å·

### å®‰è£…

1. å…‹éš†ä»“åº“ï¼š
```bash
git clone https://github.com/beilunyang/moemail.git
cd moemail
```

2. å®‰è£…ä¾èµ–ï¼š
```bash
pnpm install
```

3. è®¾ç½® wranglerï¼š
```bash
cp wrangler.example.toml wrangler.toml
cp wrangler.email.example.toml wrangler.email.toml
cp wrangler.cleanup.example.toml wrangler.cleanup.toml
```
è®¾ç½® Cloudflare D1 æ•°æ®åº“åä»¥åŠæ•°æ®åº“ ID

4. è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
```bash
cp .env.example .env.local
```
è®¾ç½® AUTH_GITHUB_ID, AUTH_GITHUB_SECRET, AUTH_SECRET

5. åˆ›å»ºæœ¬åœ°æ•°æ®åº“è¡¨ç»“æ„
```bash
pnpm db:migrate-local
```

### è°ƒè¯•ä¸å¼€å‘
6. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
```bash
pnpm dev
```

7. æµ‹è¯•é‚®ä»¶ workerï¼š
ç›®å‰æ— æ³•æœ¬åœ°è¿è¡Œå¹¶æµ‹è¯•ï¼Œè¯·ä½¿ç”¨ wrangler éƒ¨ç½²é‚®ä»¶ worker å¹¶æµ‹è¯•
```bash
pnpm deploy:email
```

8. æµ‹è¯•æ¸…ç† workerï¼š
```bash
pnpm dev:cleanup
pnpm test:cleanup
```

4. ç”Ÿæˆ Mock æ•°æ®ï¼ˆé‚®ç®±ä»¥åŠé‚®ä»¶æ¶ˆæ¯ï¼‰
```bash
pnpm generate-test-data
```


###  æœ¬åœ° Wrangler éƒ¨ç½²

1. è®¾ç½® wranglerï¼š
```bash
cp wrangler.example.toml wrangler.toml
cp wrangler.email.example.toml wrangler.email.toml
cp wrangler.cleanup.example.toml wrangler.cleanup.toml
```
è®¾ç½® Cloudflare D1 æ•°æ®åº“åä»¥åŠæ•°æ®åº“ ID

2. åˆ›å»ºäº‘ç«¯ D1 æ•°æ®åº“è¡¨ç»“æ„
```bash
pnpm db:migrate-remote
```

2. éƒ¨ç½²ä¸»åº”ç”¨åˆ° Cloudflare Pagesï¼š
```bash
pnpm deploy:pages
```

3. éƒ¨ç½²é‚®ä»¶ workerï¼š
```bash
pnpm deploy:email
```

4. éƒ¨ç½²æ¸…ç† workerï¼š
```bash
pnpm deploy:cleanup
```
5. æœ‰å…³Cloudflareé…ç½®å¯è§ä¸Šè¿°çš„Github Actionsä¸­å…³äºCloudflareçš„æ‰€æœ‰é…ç½®

# å››ã€Webhook é›†æˆ

å½“æ”¶åˆ°æ–°é‚®ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šå‘ç”¨æˆ·é…ç½®å¹¶ä¸”å·²å¯ç”¨çš„ Webhook URL å‘é€ POST è¯·æ±‚ã€‚

### è¯·æ±‚å¤´
```http
Content-Type: application/json
X-Webhook-Event: new_message
```

### è¯·æ±‚ä½“
```json
{
  "emailId": "email-uuid",
  "messageId": "message-uuid",
  "fromAddress": "sender@example.com",
  "subject": "é‚®ä»¶ä¸»é¢˜",
  "content": "é‚®ä»¶æ–‡æœ¬å†…å®¹",
  "html": "é‚®ä»¶HTMLå†…å®¹",
  "receivedAt": "2024-01-01T12:00:00.000Z",
  "toAddress": "your-email@moemail.app"
}
```

### é…ç½®è¯´æ˜
1. ç‚¹å‡»ä¸ªäººå¤´åƒï¼Œè¿›å…¥ä¸ªäººä¸­å¿ƒ
2. åœ¨ä¸ªäººä¸­å¿ƒå¯ç”¨ Webhook
3. è®¾ç½®æ¥æ”¶é€šçŸ¥çš„ URL
4. ç‚¹å‡»æµ‹è¯•æŒ‰é’®éªŒè¯é…ç½®
5. ä¿å­˜é…ç½®åå³å¯æ¥æ”¶æ–°é‚®ä»¶é€šçŸ¥

### æµ‹è¯•

é¡¹ç›®æä¾›äº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•æœåŠ¡å™¨, å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿è¡Œ:

```bash
pnpm webhook-test-server
```

æµ‹è¯•æœåŠ¡å™¨ä¼šåœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œç›‘å¬ 3001 ç«¯å£ï¼ˆhttp://localhost:3001ï¼‰ï¼Œå¹¶æ‰“å°æ”¶åˆ°çš„ Webhook æ¶ˆæ¯è¯¦æƒ…ã€‚

å¦‚æœéœ€è¦è¿›è¡Œå¤–ç½‘æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡ Cloudflare Tunnel å°†æœåŠ¡æš´éœ²åˆ°å¤–ç½‘ï¼š
```bash
pnpx cloudflared tunnel --url http://localhost:3001
```

### æ³¨æ„äº‹é¡¹
- Webhook æ¥å£åº”åœ¨ 10 ç§’å†…å“åº”
- é 2xx å“åº”ç ä¼šè§¦å‘é‡è¯•




## è´¡çŒ®

æ¬¢è¿æäº¤ Pull Request æˆ–è€… Issueæ¥å¸®åŠ©æ”¹è¿›è¿™ä¸ªé¡¹ç›®

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT](LICENSE) è®¸å¯è¯

## äº¤æµç¾¤
<img src="https://pic.otaku.ren/20241215/AQADXcMxGyDw-FZ-.jpg" style="width: 400px;"/>
<br />
å¦‚äºŒç»´ç å¤±æ•ˆï¼Œè¯·æ·»åŠ æˆ‘çš„ä¸ªäººå¾®ä¿¡ï¼ˆhansenonesï¼‰ï¼Œå¹¶å¤‡æ³¨ â€œMoeMailâ€ åŠ å…¥å¾®ä¿¡äº¤æµç¾¤

## æ”¯æŒ

å¦‚æœä½ å–œæ¬¢è¿™ä¸ªé¡¹ç›®ï¼Œæ¬¢è¿ç»™å®ƒä¸€ä¸ª Star â­ï¸
æˆ–è€…è¿›è¡ŒèµåŠ©
<br />
<br />
<img src="https://pic.otaku.ren/20240212/AQADPrgxGwoIWFZ-.jpg" style="width: 400px;"/>
<br />
<br />
<a href="https://www.buymeacoffee.com/beilunyang" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee" style="width: 400px;" ></a>
